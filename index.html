<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zigzag Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #202124; --bg2: #28292c; --bg3: #303134; --bg4: #3c3f43; --bg5: #48494d;
    --border: #3c3f43; --border2: #5f6368; --text: #e8eaed; --text2: #bdc1c6; --text3: #9aa0a6;
    --accent: #8ab4f8; --danger: #f28b82; --success: #81c995; --warn: #fdd663; --pin: #fdd663;
    --radius: 8px; --radius2: 24px; --hh: 56px; --sbw: 280px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'Manrope', sans-serif; overflow: hidden; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #auth-screen {
    position: fixed; inset: 0; z-index: 9999;
    display: flex; align-items: stretch; background: var(--bg);
  }
  .auth-left {
    flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: flex-start;
    padding: 64px 72px; position: relative; overflow: hidden;
  }
  .auth-left::before {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(ellipse at 20% 50%, #232323 0%, #111 60%); z-index: 0;
  }
  .auth-left-grid {
    position: absolute; inset: 0; z-index: 0;
    background-image: linear-gradient(var(--border) 1px, transparent 1px), linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 40px 40px; opacity: 0.4;
  }
  .auth-brand { position: relative; z-index: 1; }
  .auth-brand-logo {
    font-family: 'Space Mono', monospace; font-size: 13px; font-weight: 700;
    color: var(--text3); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 48px;
    display: flex; align-items: center; gap: 8px;
  }
  .auth-brand-logo::before { content: ''; display: block; width: 20px; height: 1px; background: var(--text3); }
  .auth-hero {
    font-family: 'Space Mono', monospace; font-size: clamp(32px, 4vw, 52px); font-weight: 700;
    color: var(--text); line-height: 1.15; margin-bottom: 20px; letter-spacing: -1px;
  }
  .auth-hero em { color: var(--text3); font-style: normal; display: block; }
  .auth-tagline { font-size: 14px; color: var(--text3); line-height: 1.6; max-width: 320px; }
  .auth-features { margin-top: 48px; display: flex; flex-direction: column; gap: 12px; }
  .auth-feat { display: flex; align-items: center; gap: 12px; color: var(--text2); font-size: 13px; }
  .auth-feat-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--text3); flex-shrink: 0; }
  .auth-right {
    width: 420px; min-width: 380px; background: var(--bg2);
    border-left: 1px solid var(--border); display: flex; flex-direction: column;
    justify-content: center; padding: 48px 40px;
  }
  .auth-right-title { font-size: 20px; font-weight: 800; color: var(--text); margin-bottom: 6px; }
  .auth-right-sub { font-size: 13px; color: var(--text3); margin-bottom: 32px; }
  .lang-row { display: flex; gap: 5px; margin-bottom: 28px; flex-wrap: wrap; }
  .lang-chip { padding: 4px 11px; background: var(--bg3); border: 1px solid var(--border); border-radius: 20px; font-size: 11px; cursor: pointer; color: var(--text3); transition: all 0.15s; font-weight: 600; }
  .lang-chip.on { background: var(--bg4); color: var(--text); border-color: var(--border2); }
  .lang-chip:hover { color: var(--text2); border-color: var(--border2); }
  .auth-tabs { display: flex; gap: 0; background: var(--bg3); border-radius: var(--radius); padding: 3px; margin-bottom: 24px; }
  .auth-tab { flex: 1; padding: 8px; text-align: center; font-size: 13px; font-weight: 600; border-radius: 6px; cursor: pointer; color: var(--text3); transition: all 0.15s; }
  .auth-tab.on { background: var(--bg5); color: var(--text); }
  .auth-field { margin-bottom: 14px; }
  .auth-field label { display: block; font-size: 11px; font-weight: 700; color: var(--text3); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.8px; }
  .auth-field input { width: 100%; padding: 10px 14px; background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 14px; font-family: 'Manrope',sans-serif; outline: none; transition: border-color 0.2s; }
  .auth-field input:focus { border-color: var(--border2); background: var(--bg4); }
  .auth-btn { width: 100%; padding: 11px; background: var(--bg5); border: 1px solid var(--border2); border-radius: var(--radius); color: var(--text); font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-family: 'Manrope',sans-serif; margin-top: 6px; letter-spacing: 0.3px; }
  .auth-btn:hover { background: var(--border2); }
  .auth-err { color: var(--danger); font-size: 12px; margin-top: 10px; display: none; }
  @media (max-width: 768px) {
    .auth-left { display: none; }
    .auth-right { width: 100%; min-width: unset; border-left: none; }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP LAYOUT â€” GOOGLE KEEP STYLE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #app { display: flex; flex-direction: column; height: 100vh; display: none; }

  /* TOP HEADER BAR */
  #gk-header {
    height: var(--hh); background: var(--bg); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 12px; padding: 0 8px 0 8px;
    position: relative; z-index: 50; flex-shrink: 0;
  }
  .gk-menu-btn {
    width: 40px; height: 40px; border-radius: 50%; background: none; border: none;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    color: var(--text3); font-size: 18px; transition: background 0.15s; flex-shrink: 0;
  }
  .gk-menu-btn:hover { background: var(--bg3); }
  .gk-logo {
    display: flex; align-items: center; gap: 8px; text-decoration: none;
    flex-shrink: 0; margin-right: 4px;
  }
  .gk-logo-icon {
    width: 32px; height: 32px; background: linear-gradient(135deg, #fdd663, #f8a000);
    border-radius: 8px; display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
  }
  .gk-logo-text {
    font-family: 'Space Mono', monospace; font-size: 18px; font-weight: 700;
    color: var(--text2); letter-spacing: -0.5px;
  }

  /* SEARCH BAR */
  .gk-search {
    flex: 1; max-width: 700px; margin: 0 auto;
    background: var(--bg3); border-radius: 24px; border: none;
    display: flex; align-items: center; gap: 12px; padding: 0 16px 0 20px;
    height: 40px; transition: background 0.2s, box-shadow 0.2s;
  }
  .gk-search:focus-within { background: var(--bg4); box-shadow: 0 2px 12px rgba(0,0,0,0.4); }
  .gk-search svg { opacity: 0.55; flex-shrink: 0; }
  .gk-search input {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text); font-size: 15px; font-family: 'Manrope',sans-serif;
  }
  .gk-search input::placeholder { color: var(--text3); }

  /* HEADER RIGHT ACTIONS */
  .gk-hdr-actions { display: flex; align-items: center; gap: 2px; margin-left: auto; flex-shrink: 0; }
  .gk-hbtn {
    width: 40px; height: 40px; border-radius: 50%; background: none; border: none;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    color: var(--text3); font-size: 18px; transition: background 0.15s;
  }
  .gk-hbtn:hover { background: var(--bg3); }
  .gk-avatar {
    width: 36px; height: 36px; border-radius: 50%;
    background: linear-gradient(135deg, #8ab4f8, #4a90d9);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 700; color: #fff; cursor: pointer; flex-shrink: 0;
    border: 2px solid transparent; transition: border-color 0.15s;
  }
  .gk-avatar:hover { border-color: var(--border2); }

  /* BODY = SIDEBAR + MAIN */
  #gk-body { flex: 1; display: flex; overflow: hidden; }

  /* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #sidebar {
    width: var(--sbw); flex-shrink: 0; background: var(--bg);
    overflow-y: auto; overflow-x: hidden; padding: 8px 0;
    transition: width 0.2s ease;
  }
  #sidebar::-webkit-scrollbar { width: 0; }
  .sb-item {
    display: flex; align-items: center; gap: 0; padding: 0 12px 0 12px;
    height: 44px; border-radius: 0 24px 24px 0; cursor: pointer;
    color: var(--text2); font-size: 14px; font-weight: 500;
    transition: background 0.12s; user-select: none; margin-right: 12px;
    position: relative;
  }
  .sb-item:hover { background: var(--bg3); }
  .sb-item.on { background: var(--bg4); color: var(--text); font-weight: 600; }
  .sb-item-ic {
    width: 40px; height: 44px; display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
  }
  .sb-item-lbl { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .sb-cnt {
    font-size: 12px; color: var(--text3); font-weight: 600;
    background: var(--bg3); padding: 1px 7px; border-radius: 10px;
  }
  .sb-item.on .sb-cnt { background: var(--bg5); color: var(--text2); }
  .sb-divider { height: 1px; background: var(--border); margin: 8px 0; }
  .sb-folders-head {
    padding: 4px 24px; font-size: 11px; font-weight: 700; color: var(--text3);
    text-transform: uppercase; letter-spacing: 1.2px; margin-top: 4px;
  }
  .sb-folders { padding: 0; }
  .sb-bot { padding: 8px 12px; margin-right: 12px; }
  .add-folder-btn {
    width: 100%; padding: 10px 12px; background: none; border: 1px dashed var(--border);
    border-radius: 20px; color: var(--text3); font-size: 13px; cursor: pointer;
    transition: all 0.15s; font-family: 'Manrope',sans-serif;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .add-folder-btn:hover { border-color: var(--border2); color: var(--text2); background: var(--bg3); }

  /* â”€â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

  /* "CREATE NOTE" input bar (like Keep's "Take a note...") */
  #create-bar-wrap { padding: 16px 20px 0; flex-shrink: 0; }
  #create-bar {
    max-width: 600px; margin: 0 auto;
    background: var(--bg2); border: 1px solid var(--border2);
    border-radius: var(--radius2); padding: 14px 20px;
    display: flex; align-items: center; gap: 12px;
    cursor: pointer; transition: box-shadow 0.2s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  #create-bar:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.5); }
  .cb-text { flex: 1; font-size: 15px; color: var(--text3); }
  .cb-actions { display: flex; gap: 4px; }
  .cb-btn {
    width: 36px; height: 36px; border-radius: 50%; background: none; border: none;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    color: var(--text3); font-size: 16px; transition: background 0.15s;
  }
  .cb-btn:hover { background: var(--bg4); color: var(--text2); }

  /* SORT/VIEW TOOLBAR */
  #gk-toolbar {
    display: flex; align-items: center; gap: 8px;
    padding: 12px 20px 0; flex-shrink: 0;
  }
  .gk-tb-title { font-size: 12px; color: var(--text3); font-weight: 600; flex: 1; letter-spacing: 0.3px; }
  #stats-bar { display: none; }
  .sort-sel {
    background: none; border: 1px solid var(--border); border-radius: 20px;
    color: var(--text3); font-size: 12px; padding: 5px 10px; outline: none;
    font-family: 'Manrope',sans-serif; cursor: pointer;
  }
  .sort-sel:hover { border-color: var(--border2); color: var(--text2); }
  .gk-view-btn {
    width: 34px; height: 34px; border-radius: 50%; background: none; border: none;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    color: var(--text3); font-size: 17px; transition: background 0.15s;
  }
  .gk-view-btn:hover { background: var(--bg3); color: var(--text2); }

  /* NOTES AREA */
  #notes-area { flex: 1; overflow-y: auto; padding: 12px 20px 20px; }
  #notes-area::-webkit-scrollbar { width: 6px; }
  #notes-area::-webkit-scrollbar-thumb { background: var(--bg3); border-radius: 3px; }

  /* MASONRY GRID */
  #nc {
    columns: auto 220px; column-gap: 12px;
    max-width: 1400px;
  }
  #nc.lv {
    columns: 1; max-width: 600px; margin: 0 auto;
  }

  /* NOTE CARD â€” Keep style */
  .nc {
    background: var(--bg); border: 1px solid var(--border2);
    border-radius: 8px; padding: 14px 16px 10px;
    cursor: pointer; transition: border-color 0.15s, box-shadow 0.15s;
    position: relative; break-inside: avoid;
    margin-bottom: 12px; display: inline-block; width: 100%;
    animation: fi 0.15s ease;
  }
  @keyframes fi { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: none; } }
  .nc:hover { border-color: var(--border2); box-shadow: 0 4px 16px rgba(0,0,0,0.35); }
  .nc.pinned { border-color: var(--border2); }
  .nc-color { position: absolute; left: 0; top: 0; bottom: 0; width: 3px; border-radius: 8px 0 0 8px; }
  .nc-title { font-size: 14px; font-weight: 700; color: var(--text); line-height: 1.4; margin-bottom: 6px; padding-right: 28px; }
  .nc-preview { font-size: 13px; color: var(--text2); line-height: 1.55; display: -webkit-box; -webkit-line-clamp: 10; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 8px; }
  .nc-meta { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; padding-top: 6px; }
  .nc-date { font-size: 11px; color: var(--text3); flex: 1; }
  .nc-tag { font-size: 11px; color: var(--text3); background: var(--bg3); padding: 1px 7px; border-radius: 10px; }
  .nc-pin-badge { position: absolute; top: 10px; right: 10px; font-size: 12px; opacity: 0.6; }
  .nc-acts { display: none; position: absolute; bottom: 8px; right: 8px; gap: 2px; }
  .nc:hover .nc-acts { display: flex; }
  .nc-act {
    width: 28px; height: 28px; border-radius: 50%; background: none; border: none;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 13px; transition: background 0.12s; color: var(--text3);
  }
  .nc-act:hover { background: var(--bg4); color: var(--text2); }
  .nc-act.d:hover { background: #2a1010; color: var(--danger); }

  /* EMPTY STATE */
  .empty {
    column-span: all; text-align: center; padding: 80px 20px;
    display: flex; flex-direction: column; align-items: center; gap: 16px;
  }
  .empty-ic {
    width: 100px; height: 100px; opacity: 0.18;
  }
  .empty-txt { font-size: 18px; color: var(--text3); font-weight: 400; }
  .empty-sub { font-size: 13px; color: var(--text3); opacity: 0.6; }

  /* SECTION HEADERS (Pinned / Others) */
  .nc-section-lbl {
    column-span: all; font-size: 11px; font-weight: 700; color: var(--text3);
    text-transform: uppercase; letter-spacing: 1.2px; padding: 4px 4px 10px;
  }
  /* for lv mode, these need to span */
  #nc.lv .nc-section-lbl { display: block; }

  /* â”€â”€â”€ EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #eo { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  #eo.open { display: flex; }
  #eb { background: var(--bg2); border: 1px solid var(--border2); border-radius: var(--radius2); width: 740px; max-width: 95vw; height: 84vh; max-height: 680px; display: flex; flex-direction: column; overflow: hidden; animation: su 0.18s ease; }
  @keyframes su { from { opacity: 0; transform: translateY(16px) scale(0.98); } to { opacity: 1; transform: none; } }
  #eh { display: flex; align-items: center; gap: 8px; padding: 12px 14px; border-bottom: 1px solid var(--border); background: var(--bg3); }
  #epin { background: none; border: none; cursor: pointer; font-size: 15px; filter: grayscale(1); opacity: 0.4; transition: all 0.15s; flex-shrink: 0; }
  #epin.on { filter: none; opacity: 1; }
  #etitle { flex: 1; background: none; border: none; outline: none; color: var(--text); font-size: 17px; font-weight: 700; font-family: 'Manrope',sans-serif; min-width: 0; }
  #ecat { background: none; border: none; outline: none; color: var(--text3); font-size: 12px; font-family: 'Manrope',sans-serif; width: 100px; }
  #erem { background: var(--bg4); border: 1px solid var(--border); border-radius: 5px; padding: 3px 7px; color: var(--text2); font-size: 11px; outline: none; }
  .ehb { padding: 5px 10px; background: var(--bg4); border: 1px solid var(--border); border-radius: 5px; color: var(--text2); font-size: 12px; cursor: pointer; transition: all 0.15s; font-family: 'Manrope',sans-serif; font-weight: 600; }
  .ehb:hover { background: var(--bg5); color: var(--text); }
  .ehb.sv { background: var(--bg5); color: var(--text); border-color: var(--border2); }
  #et { display: flex; align-items: center; gap: 3px; padding: 7px 14px; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
  .tb { width: 26px; height: 26px; background: none; border: 1px solid transparent; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--text2); transition: all 0.12s; font-weight: 700; }
  .tb:hover { background: var(--bg4); color: var(--text); border-color: var(--border); }
  .tsep { width: 1px; height: 18px; background: var(--border); margin: 0 3px; }
  #ec { flex: 1; padding: 15px; outline: none; font-size: 14px; line-height: 1.7; color: var(--text); overflow-y: auto; font-family: 'Manrope',sans-serif; }
  #ec::-webkit-scrollbar { width: 4px; }
  #ec::-webkit-scrollbar-thumb { background: var(--bg4); border-radius: 2px; }
  #ec h2 { font-size: 18px; color: var(--text); margin: 8px 0 4px; }
  #ec h3 { font-size: 15px; color: var(--text2); margin: 6px 0 2px; }
  #ec code { background: var(--bg4); padding: 1px 5px; border-radius: 3px; font-family: 'Space Mono',monospace; font-size: 12px; }
  #ec a { color: var(--text2); }
  #ef { display: flex; align-items: center; gap: 8px; padding: 9px 14px; border-top: 1px solid var(--border); background: var(--bg3); }
  .tag-inp { background: var(--bg4); border: 1px solid var(--border); border-radius: 16px; padding: 3px 10px; font-size: 12px; color: var(--text); outline: none; font-family: 'Manrope',sans-serif; width: 130px; }
  .tag-inp::placeholder { color: var(--text3); }
  #etags { display: flex; gap: 5px; flex-wrap: wrap; flex: 1; }
  .etag { font-size: 11px; background: var(--bg4); border: 1px solid var(--border); color: var(--text2); padding: 2px 7px; border-radius: 8px; display: flex; align-items: center; gap: 3px; }
  .etag-x { cursor: pointer; color: var(--text3); font-size: 10px; }
  .etag-x:hover { color: var(--danger); }
  #echars { font-size: 11px; color: var(--text3); white-space: nowrap; }

  /* â”€â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .mo { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 200; display: none; align-items: center; justify-content: center; }
  .mo.open { display: flex; }
  .mb { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius2); padding: 26px; width: 380px; max-width: 90vw; animation: su 0.18s ease; }
  .mb-title { font-size: 15px; font-weight: 700; margin-bottom: 18px; }
  .mb-field { margin-bottom: 12px; }
  .mb-field label { display: block; font-size: 11px; font-weight: 700; color: var(--text2); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
  .mb-field input, .mb-field select { width: 100%; padding: 8px 11px; background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 13px; outline: none; font-family: 'Manrope',sans-serif; }
  .mb-actions { display: flex; gap: 7px; justify-content: flex-end; margin-top: 18px; }
  .mbtn { padding: 7px 16px; border-radius: var(--radius); border: 1px solid var(--border); font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Manrope',sans-serif; transition: all 0.15s; }
  .mbtn.p { background: var(--bg5); color: var(--text); border-color: var(--border2); }
  .mbtn.p:hover { background: var(--border2); }
  .mbtn.s { background: var(--bg3); color: var(--text2); }
  .mbtn.s:hover { background: var(--bg4); }
  .mbtn.d { background: #2a1010; color: var(--danger); border-color: var(--danger); }
  .mbtn.d:hover { background: #3a1515; }

  /* â”€â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #so { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 200; display: none; align-items: center; justify-content: center; }
  #so.open { display: flex; }
  #sb2 { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius2); width: 480px; max-width: 92vw; max-height: 80vh; overflow-y: auto; animation: su 0.18s ease; }
  .s-head { display: flex; align-items: center; padding: 18px 22px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--bg2); z-index: 1; }
  .s-head h2 { flex: 1; font-size: 15px; font-weight: 700; }
  .s-close { background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text3); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .s-close:hover { background: var(--bg3); color: var(--text); }
  .s-body { padding: 18px 22px; }
  .s-sec { margin-bottom: 24px; }
  .s-sec h3 { font-size: 10px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
  .s-row { display: flex; align-items: center; justify-content: space-between; padding: 9px 0; border-bottom: 1px solid var(--border); }
  .s-row:last-child { border-bottom: none; }
  .s-row-l { font-size: 13px; }
  .s-row-s { font-size: 11px; color: var(--text3); margin-top: 2px; }
  .s-sel { background: var(--bg3); border: 1px solid var(--border); border-radius: 5px; padding: 5px 9px; color: var(--text); font-size: 12px; outline: none; font-family: 'Manrope',sans-serif; cursor: pointer; }
  .s-dbtn { padding: 6px 13px; background: #2a1010; border: 1px solid var(--danger); border-radius: 20px; color: var(--danger); font-size: 12px; cursor: pointer; font-family: 'Manrope',sans-serif; transition: all 0.15s; }
  .s-dbtn:hover { background: #3a1515; }

  /* SCREEN SIZE BUTTONS */
  .screen-size-btns { display: flex; gap: 4px; }
  .ssb {
    width: 36px; height: 32px; background: var(--bg3); border: 1px solid var(--border);
    border-radius: 6px; cursor: pointer; font-size: 16px; display: flex; align-items: center;
    justify-content: center; transition: all 0.15s; opacity: 0.5;
  }
  .ssb:hover { background: var(--bg4); opacity: 0.8; border-color: var(--border2); }
  .ssb.active { background: var(--bg4); border-color: var(--border2); opacity: 1; box-shadow: inset 0 0 0 1px var(--border2); }

  /* â”€â”€â”€ CTX MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #ctx { position: fixed; background: var(--bg3); border: 1px solid var(--border2); border-radius: var(--radius); padding: 4px; z-index: 999; min-width: 170px; display: none; box-shadow: 0 8px 24px rgba(0,0,0,0.45); }
  .ctx-i { padding: 8px 14px; font-size: 13px; color: var(--text2); cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 10px; transition: all 0.12s; }
  .ctx-i:hover { background: var(--bg4); color: var(--text); }
  .ctx-i.d { color: var(--danger); }
  .ctx-i.d:hover { background: #2a1010; }
  .ctx-sep { height: 1px; background: var(--border); margin: 4px 0; }

  /* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #toast-c { position: fixed; bottom: 22px; right: 22px; z-index: 9999; display: flex; flex-direction: column; gap: 7px; }
  .toast { background: var(--bg4); border: 1px solid var(--border2); border-radius: 24px; padding: 10px 20px; font-size: 13px; color: var(--text); display: flex; align-items: center; gap: 9px; animation: ti 0.25s ease; min-width: 200px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
  @keyframes ti { from { opacity: 0; transform: translateX(16px); } to { opacity: 1; transform: none; } }
  .toast.ok { border-color: var(--success); }
  .toast.er { border-color: var(--danger); }
  .spin { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--text2); border-radius: 50%; animation: sp 0.8s linear infinite; margin: auto; }
  @keyframes sp { to { transform: rotate(360deg); } }

  /* â”€â”€â”€ LAYOUT MODES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  body.layout-mobile #sidebar { display: none; }
  body.layout-mobile #create-bar { max-width: 100%; }
  body.layout-mobile #nc { columns: 1; }
  body.layout-mobile #nc.lv { columns: 1; }
  body.layout-mobile #gk-logo-text { display: none; }

  body.layout-tablet #sidebar { width: 200px; }
  body.layout-tablet #nc { columns: auto 180px; }
  body.layout-tablet #sb2 { width: 95vw; }

  body.layout-desktop #sidebar { width: var(--sbw); }

  /* â”€â”€â”€ SIDEBAR COLLAPSED (hamburger) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  body.sb-collapsed #sidebar { width: 72px; }
  body.sb-collapsed .sb-item-lbl { display: none; }
  body.sb-collapsed .sb-cnt { display: none; }
  body.sb-collapsed .sb-folders-head { display: none; }
  body.sb-collapsed .add-folder-btn span:last-child { display: none; }
  body.sb-collapsed .sb-item { justify-content: center; padding: 0; margin-right: 4px; border-radius: 50%; width: 48px; height: 48px; margin: 0 auto 4px; }
  body.sb-collapsed .sb-item-ic { width: 48px; }
  body.sb-collapsed .sb-divider { margin: 4px 8px; }
  body.sb-collapsed .add-folder-btn { border-radius: 50%; width: 48px; height: 48px; padding: 0; justify-content: center; }

  /* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 600px) {
    #sidebar { display: none; }
    #nc { columns: 1; }
    #eb { width: 100%; height: 100%; border-radius: 0; }
    #create-bar { max-width: 100%; }
    .gk-logo-text { display: none; }
  }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-left">
    <div class="auth-left-grid"></div>
    <div class="auth-brand">
      <div class="auth-brand-logo">Zigzag Notes</div>
      <div class="auth-hero">Ğ£Ğ¼Ğ½Ñ‹Ğµ<br>Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸<em>Ğ´Ğ»Ñ Ğ²ÑĞµĞ³Ğ¾.</em></div>
      <div class="auth-tagline" id="a-tag">Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾Ğ´ Ñ€ÑƒĞºĞ¾Ğ¹. ĞĞ±Ğ»Ğ°Ñ‡Ğ½Ğ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ, Ğ¼Ğ¾Ñ‰Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€, ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ² ZIP.</div>
      <div class="auth-features">
        <div class="auth-feat"><div class="auth-feat-dot"></div>ĞĞ±Ğ»Ğ°Ñ‡Ğ½Ğ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¸ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ</div>
        <div class="auth-feat"><div class="auth-feat-dot"></div>Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ / Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ZIP Ñ JS-ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°Ğ¼Ğ¸</div>
        <div class="auth-feat"><div class="auth-feat-dot"></div>4 ÑĞ·Ñ‹ĞºĞ° Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°</div>
        <div class="auth-feat"><div class="auth-feat-dot"></div>Ğ¢ĞµĞ³Ğ¸, Ğ¿Ğ°Ğ¿ĞºĞ¸, Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ, Ğ°Ñ€Ñ…Ğ¸Ğ²</div>
      </div>
    </div>
  </div>
  <div class="auth-right">
    <div class="auth-right-title" id="ar-title">Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ</div>
    <div class="auth-right-sub" id="ar-sub">Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹</div>
    <div class="lang-row">
      <div class="lang-chip on" data-l="ru" onclick="aLang('ru',this)">ğŸ‡·ğŸ‡º Ğ ÑƒÑ</div>
      <div class="lang-chip" data-l="en" onclick="aLang('en',this)">ğŸ‡¬ğŸ‡§ Eng</div>
      <div class="lang-chip" data-l="es" onclick="aLang('es',this)">ğŸ‡ªğŸ‡¸ Esp</div>
      <div class="lang-chip" data-l="zh" onclick="aLang('zh',this)">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</div>
    </div>
    <div class="auth-tabs">
      <div class="auth-tab on" id="at-li" onclick="sTab('li')">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</div>
      <div class="auth-tab" id="at-re" onclick="sTab('re')">Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</div>
    </div>
    <div id="f-li">
      <div class="auth-field"><label>Email</label><input type="email" id="li-em" placeholder="you@example.com"></div>
      <div class="auth-field"><label id="li-pl">ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ</label><input type="password" id="li-pw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <button class="auth-btn" onclick="doLogin()" id="li-btn">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
    </div>
    <div id="f-re" style="display:none">
      <div class="auth-field"><label>Email</label><input type="email" id="re-em" placeholder="you@example.com"></div>
      <div class="auth-field"><label id="re-pl">ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ</label><input type="password" id="re-pw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
      <div class="auth-field"><label id="re-p2l">ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ</label><input type="password" id="re-pw2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doReg()"></div>
      <button class="auth-btn" onclick="doReg()" id="re-btn">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</button>
    </div>
    <div class="auth-err" id="a-err"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">

  <!-- TOP HEADER -->
  <header id="gk-header">
    <button class="gk-menu-btn" onclick="togSidebar()" title="ĞœĞµĞ½Ñ">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </button>
    <div class="gk-logo">
      <div class="gk-logo-icon">âœï¸</div>
      <span class="gk-logo-text" id="gk-logo-text">Zigzag</span>
    </div>
    <div class="gk-search">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" id="si" placeholder="ĞŸĞ¾Ğ¸ÑĞº..." oninput="onSrch()">
    </div>
    <div class="gk-hdr-actions">
      <button class="gk-hbtn" onclick="doImport()" title="Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ZIP">ğŸ“¥</button>
      <button class="gk-hbtn" onclick="exportAll()" title="Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ ZIP">ğŸ“¤</button>
      <button class="gk-hbtn" onclick="openSettings()" title="ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸">âš™ï¸</button>
      <div class="gk-avatar" id="gk-avatar" onclick="openSettings()" title="ĞĞºĞºĞ°ÑƒĞ½Ñ‚">Z</div>
    </div>
  </header>

  <!-- BODY: SIDEBAR + CONTENT -->
  <div id="gk-body">

    <!-- SIDEBAR -->
    <nav id="sidebar">
      <div class="sb-item on" id="n-all" onclick="sf('all')">
        <div class="sb-item-ic">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="opacity:0.75"><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86l-3 3.87L9 13.14 6 17h12l-3.86-5.14z"/></svg>
        </div>
        <span class="sb-item-lbl" id="t-all">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸</span>
        <span class="sb-cnt" id="c-all">0</span>
      </div>
      <div class="sb-item" id="n-rem" onclick="sf('rem')">
        <div class="sb-item-ic">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="opacity:0.75"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
        </div>
        <span class="sb-item-lbl" id="t-rem">ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ</span>
        <span class="sb-cnt" id="c-rem">0</span>
      </div>
      <div class="sb-item" id="n-pin" onclick="sf('pin')">
        <div class="sb-item-ic">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="opacity:0.75"><path d="M17 4v7l2 3v2h-6v5l-1 1-1-1v-5H5v-2l2-3V4c0-.55.45-1 1-1h8c.55 0 1 .45 1 1zm-5 15l.7-.7V13H9v5.3L9.7 19H12z"/></svg>
        </div>
        <span class="sb-item-lbl" id="t-pin">Ğ—Ğ°ĞºÑ€ĞµĞ¿Ğ»Ñ‘Ğ½Ğ½Ñ‹Ğµ</span>
        <span class="sb-cnt" id="c-pin">0</span>
      </div>

      <div class="sb-divider"></div>

      <div class="sb-folders-head" id="sb-fld-lbl">ĞŸĞ°Ğ¿ĞºĞ¸</div>
      <div class="sb-folders" id="flist"></div>
      <div class="sb-bot">
        <button class="add-folder-btn" onclick="openFolderModal()">
          <span>+</span><span id="t-nf">ĞĞ¾Ğ²Ğ°Ñ Ğ¿Ğ°Ğ¿ĞºĞ°</span>
        </button>
      </div>

      <div class="sb-divider"></div>

      <div class="sb-item" id="n-arc" onclick="sf('arc')">
        <div class="sb-item-ic">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="opacity:0.75"><path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5L6.5 12H10v-2h4v2h3.5L12 17.5zM5.12 5l.81-1h12l.94 1H5.12z"/></svg>
        </div>
        <span class="sb-item-lbl" id="t-arc">ĞÑ€Ñ…Ğ¸Ğ²</span>
        <span class="sb-cnt" id="c-arc">0</span>
      </div>
      <div class="sb-item" id="n-del" onclick="sf('del')">
        <div class="sb-item-ic">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="opacity:0.75"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
        </div>
        <span class="sb-item-lbl" id="t-del">ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ°</span>
        <span class="sb-cnt" id="c-del">0</span>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div id="main">

      <!-- CREATE NOTE BAR -->
      <div id="create-bar-wrap">
        <div id="create-bar" onclick="openNew()">
          <span class="cb-text" id="t-new-note">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºÑƒ...</span>
          <div class="cb-actions" onclick="event.stopPropagation()">
            <button class="cb-btn" onclick="openNew()" title="ĞĞ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ°">âœï¸</button>
          </div>
        </div>
      </div>

      <!-- SORT/VIEW TOOLBAR -->
      <div id="gk-toolbar">
        <span class="gk-tb-title" id="tb-ttl">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸</span>
        <select class="sort-sel" id="ss" onchange="onSort()">
          <option value="updated_at" id="so-upd">ĞŸĞ¾ Ğ´Ğ°Ñ‚Ğµ</option>
          <option value="title" id="so-ttl">ĞŸĞ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ</option>
          <option value="created_at" id="so-cre">ĞŸĞ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ</option>
        </select>
        <button class="gk-view-btn" id="vb" onclick="togView()" title="Ğ’Ğ¸Ğ´">âŠ</button>
      </div>

      <!-- hidden stats bar (kept for JS compatibility) -->
      <div id="stats-bar"><span id="stats-t">0 Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¾Ğº</span></div>

      <!-- NOTES GRID -->
      <div id="notes-area"><div id="nc"></div></div>
    </div>

  </div><!-- /#gk-body -->
</div><!-- /#app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EDITOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="eo"><div id="eb">
  <div id="eh">
    <button id="epin" onclick="togPin()">ğŸ“Œ</button>
    <input type="text" id="etitle" placeholder="Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº...">
    <input type="text" id="ecat" placeholder="ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ...">
    <input type="datetime-local" id="erem">
    <button class="ehb" onclick="closeEd()">âœ•</button>
    <button class="ehb sv" id="esave-btn" onclick="saveNote()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
  </div>
  <div id="et">
    <button class="tb" onclick="f('bold')"><b>B</b></button>
    <button class="tb" onclick="f('italic')"><i>I</i></button>
    <button class="tb" onclick="f('underline')"><u>U</u></button>
    <button class="tb" onclick="f('strikeThrough')"><s>S</s></button>
    <div class="tsep"></div>
    <button class="tb" onclick="fb('h2')" style="font-size:10px">H2</button>
    <button class="tb" onclick="fb('h3')" style="font-size:10px">H3</button>
    <button class="tb" onclick="f('insertUnorderedList')">â‰¡</button>
    <button class="tb" onclick="f('insertOrderedList')" style="font-size:10px">1.</button>
    <div class="tsep"></div>
    <button class="tb" onclick="f('justifyLeft')">â—</button>
    <button class="tb" onclick="f('justifyCenter')">â–¶â—€</button>
    <button class="tb" onclick="f('justifyRight')">â–·</button>
    <div class="tsep"></div>
    <button class="tb" onclick="inHR()">â€”</button>
    <button class="tb" onclick="inCode()" style="font-size:10px">&lt;/&gt;</button>
    <button class="tb" onclick="inLink()">ğŸ”—</button>
    <div class="tsep"></div>
    <input type="color" id="nclr" value="#2a2a2a" title="Ğ¦Ğ²ĞµÑ‚" style="width:26px;height:26px;border:none;border-radius:4px;cursor:pointer;background:none;padding:1px">
  </div>
  <div id="ec" contenteditable="true" onkeydown="edKey(event)" oninput="updChars()"></div>
  <div id="ef">
    <input class="tag-inp" id="tgi" placeholder="# Ñ‚ĞµĞ³" onkeydown="tagKD(event)">
    <div id="etags"></div>
    <span id="echars">0 ÑĞ¸Ğ¼Ğ².</span>
  </div>
</div></div>

<!-- FOLDER MODAL -->
<div class="mo" id="fm"><div class="mb">
  <div class="mb-title" id="fm-ttl">ĞĞ¾Ğ²Ğ°Ñ Ğ¿Ğ°Ğ¿ĞºĞ°</div>
  <div class="mb-field"><label id="fm-n">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</label><input type="text" id="fn-i"></div>
  <div class="mb-field"><label id="fm-ic">Ğ˜ĞºĞ¾Ğ½ĞºĞ°</label><input type="text" id="fi-i" value="ğŸ“" style="width:60px"></div>
  <div class="mb-field"><label id="fm-c">Ğ¦Ğ²ĞµÑ‚</label><input type="color" id="fc-i" value="#555555"></div>
  <div class="mb-actions">
    <button class="mbtn s" onclick="closeFM()" id="fm-can">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
    <button class="mbtn p" onclick="saveFM()" id="fm-sav">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
  </div>
</div></div>

<!-- DELETE MODAL -->
<div class="mo" id="dm"><div class="mb">
  <div class="mb-title" id="dm-ttl">Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºÑƒ?</div>
  <div style="font-size:13px;color:var(--text3);margin-bottom:4px" id="dm-txt">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ğ° Ğ² ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñƒ.</div>
  <div class="mb-actions">
    <button class="mbtn s" onclick="closeDM()" id="dm-can">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
    <button class="mbtn d" onclick="confirmDel()" id="dm-del">Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>
  </div>
</div></div>

<!-- SETTINGS -->
<div id="so"><div id="sb2">
  <div class="s-head"><h2 id="s-ttl">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</h2><button class="s-close" onclick="closeSettings()">âœ•</button></div>
  <div class="s-body">
    <div class="s-sec">
      <h3 id="s-acc">ĞĞºĞºĞ°ÑƒĞ½Ñ‚</h3>
      <div class="s-row"><div><div class="s-row-l" id="s-em-l">Email</div><div class="s-row-s" id="s-em">â€”</div></div><button class="s-dbtn" onclick="doLogout()" id="s-lo">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button></div>
    </div>
    <div class="s-sec">
      <h3 id="s-int">Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ</h3>
      <div class="s-row"><div><div class="s-row-l" id="s-lang-l">Ğ¯Ğ·Ñ‹Ğº</div></div>
        <select class="s-sel" id="ls" onchange="chLang(this.value)"><option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option><option value="en">ğŸ‡¬ğŸ‡§ English</option><option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option><option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option></select>
      </div>
      <div class="s-row"><div><div class="s-row-l" id="s-srt-l">Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°</div></div>
        <select class="s-sel" id="s-srt" onchange="chSort(this.value)"><option value="updated_at" id="ss-upd">ĞŸĞ¾ Ğ´Ğ°Ñ‚Ğµ</option><option value="title" id="ss-ttl">ĞŸĞ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ</option><option value="created_at" id="ss-cre">ĞŸĞ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ</option></select>
      </div>
      <div class="s-row"><div><div class="s-row-l" id="s-vw-l">Ğ’Ğ¸Ğ´</div></div>
        <select class="s-sel" id="s-vw" onchange="chView(this.value)"><option value="grid" id="sv-g">Ğ¡ĞµÑ‚ĞºĞ°</option><option value="list" id="sv-l">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº</option></select>
      </div>
      <div class="s-row">
        <div>
          <div class="s-row-l" id="s-scr-l">Ğ Ğ°Ğ·Ğ¼ĞµÑ€ ÑĞºÑ€Ğ°Ğ½Ğ°</div>
          <div class="s-row-s" id="s-scr-s">ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ</div>
        </div>
        <div class="screen-size-btns" id="screen-size-btns">
          <button class="ssb" id="ssb-mobile" onclick="chScreenSize('mobile')" title="ĞœĞ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹">ğŸ“±</button>
          <button class="ssb" id="ssb-tablet" onclick="chScreenSize('tablet')" title="ĞŸĞ»Ğ°Ğ½ÑˆĞµÑ‚">â¬œ</button>
          <button class="ssb active" id="ssb-desktop" onclick="chScreenSize('desktop')" title="ĞŸĞš">ğŸ–¥ï¸</button>
        </div>
      </div>
    </div>
    <div class="s-sec">
      <h3 id="s-data">Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸</h3>
      <div class="s-row"><div><div class="s-row-l" id="s-exp-l">Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¾Ğº</div><div class="s-row-s" id="s-exp-s">Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ ZIP Ğ°Ñ€Ñ…Ğ¸Ğ²</div></div><button class="mbtn p" onclick="exportAll()" id="s-exp-b">Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚</button></div>
      <div class="s-row"><div><div class="s-row-l" id="s-imp-l">Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¾Ğº</div><div class="s-row-s" id="s-imp-s">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ZIP Ğ°Ñ€Ñ…Ğ¸Ğ²</div></div><button class="mbtn p" onclick="doImport()" id="s-imp-b">Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚</button></div>
      <div class="s-row"><div><div class="s-row-l" id="s-tr-l">ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñƒ</div><div class="s-row-s" id="s-tr-s">Ğ‘ĞµĞ·Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ</div></div><button class="s-dbtn" onclick="emptyTrash()" id="s-tr-b">ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ</button></div>
    </div>
  </div>
</div></div>

<!-- CTX MENU -->
<div id="ctx">
  <div class="ctx-i" onclick="ca('ed')">âœï¸ <span id="cx-ed">Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</span></div>
  <div class="ctx-i" onclick="ca('pin')">ğŸ“Œ <span id="cx-pin">Ğ—Ğ°ĞºÑ€ĞµĞ¿Ğ¸Ñ‚ÑŒ</span></div>
  <div class="ctx-i" onclick="ca('arc')">ğŸ—„ï¸ <span id="cx-arc">ĞÑ€Ñ…Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</span></div>
  <div class="ctx-i" onclick="ca('exp')">ğŸ“¤ <span id="cx-exp">Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚</span></div>
  <div class="ctx-i" onclick="ca('dup')">ğŸ“‹ <span id="cx-dup">Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</span></div>
  <div class="ctx-sep"></div>
  <div class="ctx-i d" onclick="ca('del')">ğŸ—‘ï¸ <span id="cx-del">Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</span></div>
</div>

<div id="toast-c"></div>
<input type="file" id="zip-fi" accept=".zip" style="display:none" onchange="handleZip(event)">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
const SU = 'https://nnfxxmqvroaughmpdhem.supabase.co';
const SK = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uZnh4bXF2cm9hdWdobXBkaGVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODA4NzgsImV4cCI6MjA4NzQ1Njg3OH0.J40EJvQnEkHCuF7xcLBgnGpe21n29coQnni9gDt3UFs';

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = { user: null, tok: null, lang: localStorage.getItem('zz_lang')||'ru', notes: [], folders: [], prefs: { sort_by:'updated_at', view_mode:'grid' }, filt:'all', fFolder:null, q:'', editing:null, tags:[], ctxId:null, delId:null };

// â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(method, path, body, useAuth=true) {
  const tok = useAuth ? (S.tok||SK) : SK;
  const h = {'apikey':SK,'Authorization':'Bearer '+tok,'Content-Type':'application/json','Prefer':'return=representation'};
  const r = await fetch(SU+path, { method, headers:h, body: body?JSON.stringify(body):undefined });
  const txt = await r.text();
  try { return { data: JSON.parse(txt), ok: r.ok, status: r.status }; }
  catch { return { data: txt, ok: r.ok, status: r.status }; }
}
async function authApi(method, path, body) {
  const h = {'apikey':SK,'Content-Type':'application/json'};
  const r = await fetch(SU+path, { method, headers:h, body: body?JSON.stringify(body):undefined });
  return r.json();
}

// â”€â”€ TRANSLATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const T = {
  ru:{ tagline:'Ğ£Ğ¼Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸. Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾Ğ´ Ñ€ÑƒĞºĞ¾Ğ¹.', login:'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸', reg:'Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ', pw:'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ', cpw:'ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ', loginBtn:'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸', regBtn:'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚', all:'Ğ’ÑĞµ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸', pin:'Ğ—Ğ°ĞºÑ€ĞµĞ¿Ğ»Ñ‘Ğ½Ğ½Ñ‹Ğµ', rem:'Ğ¡ Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸ĞµĞ¼', arc:'ĞÑ€Ñ…Ğ¸Ğ²', del:'ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ°', nav:'ĞĞ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ', flds:'ĞŸĞ°Ğ¿ĞºĞ¸', nf:'ĞĞ¾Ğ²Ğ°Ñ Ğ¿Ğ°Ğ¿ĞºĞ°', srch:'ĞŸĞ¾Ğ¸ÑĞº...', settings:'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸', save:'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ', cancel:'ĞÑ‚Ğ¼ĞµĞ½Ğ°', delete:'Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ', delQ:'Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºÑƒ?', delTxt:'Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ğ° Ğ² ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñƒ.', edit:'Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ', pinV:'Ğ—Ğ°ĞºÑ€ĞµĞ¿Ğ¸Ñ‚ÑŒ', arcV:'ĞÑ€Ñ…Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ', expV:'Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚', dup:'Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ', acc:'ĞĞºĞºĞ°ÑƒĞ½Ñ‚', iface:'Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ', lang:'Ğ¯Ğ·Ñ‹Ğº', sort:'Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°', view:'Ğ’Ğ¸Ğ´', data:'Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸', expAll:'Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¾Ğº', expAllS:'Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ ZIP Ğ°Ñ€Ñ…Ğ¸Ğ²', impN:'Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¾Ğº', impS:'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ZIP Ğ°Ñ€Ñ…Ğ¸Ğ²', clrTr:'ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñƒ', clrTrS:'Ğ‘ĞµĞ·Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ', clr:'ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ', exp:'Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚', imp:'Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚', logout:'Ğ’Ñ‹Ğ¹Ñ‚Ğ¸', fName:'ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ', fIco:'Ğ˜ĞºĞ¾Ğ½ĞºĞ°', fClr:'Ğ¦Ğ²ĞµÑ‚', sUpd:'ĞŸĞ¾ Ğ´Ğ°Ñ‚Ğµ', sTtl:'ĞŸĞ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ', sCre:'ĞŸĞ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ', grd:'Ğ¡ĞµÑ‚ĞºĞ°', lst:'Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº', cnt:(n)=>`${n} Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¾Ğº`, noN:'ĞĞµÑ‚ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¾Ğº', noNH:'ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«ĞĞ¾Ğ²Ğ°ÑÂ» Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ', saved:'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾', deleted:'Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾', exported:'Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½', imported:(n)=>`Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾: ${n}`, trEmpty:'ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ° Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ°', duped:'Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾', pinned:'Ğ—Ğ°ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¾', unpinned:'ĞÑ‚ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¾', arcd:'ĞÑ€Ñ…Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾', unarcd:'Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¾', chars:(n)=>`${n} ÑĞ¸Ğ¼Ğ².`, newShort:'ĞĞ¾Ğ²Ğ°Ñ', createNote:'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºÑƒ...', appName:'Zigzag', welcome:'Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ', welcomeSub:'Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹', scrSize:'Ğ Ğ°Ğ·Ğ¼ĞµÑ€ ÑĞºÑ€Ğ°Ğ½Ğ°', scrSizeS:'ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ', screenChanged:(s)=>({mobile:'ğŸ“± ĞœĞ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ğ¸Ğ´',tablet:'â¬œ ĞŸĞ»Ğ°Ğ½ÑˆĞµÑ‚Ğ½Ñ‹Ğ¹ Ğ²Ğ¸Ğ´',desktop:'ğŸ–¥ï¸ Ğ’Ğ¸Ğ´ ĞŸĞš'}[s]||s) },
  en:{ tagline:'Smart notes. Always at hand.', login:'Login', reg:'Register', pw:'Password', cpw:'Confirm password', loginBtn:'Log In', regBtn:'Create Account', all:'All Notes', pin:'Pinned', rem:'With Reminders', arc:'Archive', del:'Trash', nav:'Navigation', flds:'Folders', nf:'New Folder', srch:'Search...', settings:'Settings', save:'Save', cancel:'Cancel', delete:'Delete', delQ:'Delete note?', delTxt:'Note will be moved to trash.', edit:'Edit', pinV:'Pin', arcV:'Archive', expV:'Export', dup:'Duplicate', acc:'Account', iface:'Interface', lang:'Language', sort:'Sort by', view:'View', data:'Data Management', expAll:'Export notes', expAllS:'Download ZIP archive', impN:'Import notes', impS:'Upload ZIP archive', clrTr:'Empty trash', clrTrS:'Permanent delete', clr:'Clear', exp:'Export', imp:'Import', logout:'Logout', fName:'Name', fIco:'Icon', fClr:'Color', sUpd:'By date', sTtl:'By name', sCre:'By created', grd:'Grid', lst:'List', cnt:(n)=>`${n} notes`, noN:'No notes', noNH:'Click "New" to create', saved:'Saved', deleted:'Deleted', exported:'Exported', imported:(n)=>`Imported: ${n}`, trEmpty:'Trash cleared', duped:'Duplicated', pinned:'Pinned', unpinned:'Unpinned', arcd:'Archived', unarcd:'Unarchived', chars:(n)=>`${n} chars`, newShort:'New', createNote:'Take a note...', appName:'Zigzag', welcome:'Welcome', welcomeSub:'Sign in or create a new account', scrSize:'Screen size', scrSizeS:'Adapt the interface', screenChanged:(s)=>({mobile:'ğŸ“± Mobile view',tablet:'â¬œ Tablet view',desktop:'ğŸ–¥ï¸ Desktop view'}[s]||s) },
  es:{ tagline:'Notas inteligentes. Siempre a mano.', login:'Iniciar sesiÃ³n', reg:'Registrarse', pw:'ContraseÃ±a', cpw:'Confirmar contraseÃ±a', loginBtn:'Entrar', regBtn:'Crear cuenta', all:'Todas las notas', pin:'Fijadas', rem:'Con recordatorios', arc:'Archivo', del:'Papelera', nav:'NavegaciÃ³n', flds:'Carpetas', nf:'Nueva carpeta', srch:'Buscar...', settings:'Ajustes', save:'Guardar', cancel:'Cancelar', delete:'Eliminar', delQ:'Â¿Eliminar nota?', delTxt:'La nota irÃ¡ a la papelera.', edit:'Editar', pinV:'Fijar', arcV:'Archivar', expV:'Exportar', dup:'Duplicar', acc:'Cuenta', iface:'Interfaz', lang:'Idioma', sort:'Ordenar', view:'Vista', data:'Datos', expAll:'Exportar notas', expAllS:'Descargar ZIP', impN:'Importar notas', impS:'Cargar ZIP', clrTr:'Vaciar papelera', clrTrS:'EliminaciÃ³n permanente', clr:'Limpiar', exp:'Exportar', imp:'Importar', logout:'Salir', fName:'Nombre', fIco:'Icono', fClr:'Color', sUpd:'Por fecha', sTtl:'Por nombre', sCre:'Por creaciÃ³n', grd:'CuadrÃ­cula', lst:'Lista', cnt:(n)=>`${n} notas`, noN:'Sin notas', noNH:'Clic en "Nueva" para crear', saved:'Guardado', deleted:'Eliminado', exported:'Exportado', imported:(n)=>`Importado: ${n}`, trEmpty:'Papelera limpia', duped:'Duplicado', pinned:'Fijado', unpinned:'Desfijado', arcd:'Archivado', unarcd:'Desarchivado', chars:(n)=>`${n} car.`, newShort:'Nueva', createNote:'Crear nota...', appName:'Zigzag', welcome:'Bienvenido', welcomeSub:'Inicia sesiÃ³n o crea una cuenta', scrSize:'TamaÃ±o de pantalla', scrSizeS:'Adaptar la interfaz', screenChanged:(s)=>({mobile:'ğŸ“± Vista mÃ³vil',tablet:'â¬œ Vista tableta',desktop:'ğŸ–¥ï¸ Vista PC'}[s]||s) },
  zh:{ tagline:'æ™ºèƒ½ç¬”è®°ï¼Œéšæ—¶å¯ç”¨ã€‚', login:'ç™»å½•', reg:'æ³¨å†Œ', pw:'å¯†ç ', cpw:'ç¡®è®¤å¯†ç ', loginBtn:'ç™»å½•', regBtn:'åˆ›å»ºè´¦æˆ·', all:'æ‰€æœ‰ç¬”è®°', pin:'å·²ç½®é¡¶', rem:'æœ‰æé†’', arc:'å½’æ¡£', del:'å›æ”¶ç«™', nav:'å¯¼èˆª', flds:'æ–‡ä»¶å¤¹', nf:'æ–°æ–‡ä»¶å¤¹', srch:'æœç´¢...', settings:'è®¾ç½®', save:'ä¿å­˜', cancel:'å–æ¶ˆ', delete:'åˆ é™¤', delQ:'åˆ é™¤ç¬”è®°ï¼Ÿ', delTxt:'ç¬”è®°å°†ç§»è‡³å›æ”¶ç«™ã€‚', edit:'ç¼–è¾‘', pinV:'ç½®é¡¶', arcV:'å½’æ¡£', expV:'å¯¼å‡º', dup:'å¤åˆ¶', acc:'è´¦æˆ·', iface:'ç•Œé¢', lang:'è¯­è¨€', sort:'æ’åº', view:'è§†å›¾', data:'æ•°æ®ç®¡ç†', expAll:'å¯¼å‡ºç¬”è®°', expAllS:'ä¸‹è½½ ZIP å‹ç¼©åŒ…', impN:'å¯¼å…¥ç¬”è®°', impS:'ä¸Šä¼  ZIP å‹ç¼©åŒ…', clrTr:'æ¸…ç©ºå›æ”¶ç«™', clrTrS:'æ°¸ä¹…åˆ é™¤', clr:'æ¸…ç©º', exp:'å¯¼å‡º', imp:'å¯¼å…¥', logout:'é€€å‡º', fName:'åç§°', fIco:'å›¾æ ‡', fClr:'é¢œè‰²', sUpd:'æŒ‰æ—¥æœŸ', sTtl:'æŒ‰åç§°', sCre:'æŒ‰åˆ›å»º', grd:'ç½‘æ ¼', lst:'åˆ—è¡¨', cnt:(n)=>`${n} æ¡ç¬”è®°`, noN:'æ²¡æœ‰ç¬”è®°', noNH:'ç‚¹å‡»ã€Œæ–°å»ºã€åˆ›å»º', saved:'å·²ä¿å­˜', deleted:'å·²åˆ é™¤', exported:'å·²å¯¼å‡º', imported:(n)=>`å·²å¯¼å…¥: ${n}`, trEmpty:'å›æ”¶ç«™å·²æ¸…ç©º', duped:'å·²å¤åˆ¶', pinned:'å·²ç½®é¡¶', unpinned:'å·²å–æ¶ˆç½®é¡¶', arcd:'å·²å½’æ¡£', unarcd:'å·²å–æ¶ˆå½’æ¡£', chars:(n)=>`${n} å­—ç¬¦`, newShort:'æ–°å»º', createNote:'åˆ›å»ºç¬”è®°...', appName:'Zigzag', welcome:'æ¬¢è¿', welcomeSub:'ç™»å½•æˆ–åˆ›å»ºæ–°è´¦æˆ·', scrSize:'å±å¹•å°ºå¯¸', scrSizeS:'é€‚é…ç•Œé¢', screenChanged:(s)=>({mobile:'ğŸ“± æ‰‹æœºè§†å›¾',tablet:'â¬œ å¹³æ¿è§†å›¾',desktop:'ğŸ–¥ï¸ æ¡Œé¢è§†å›¾'}[s]||s) }
};

function t(k,...a) { const l=T[S.lang]||T.ru; const v=l[k]||T.ru[k]||k; return typeof v==='function'?v(...a):v; }
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// â”€â”€ LANGUAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TM = {
  'a-tag':'tagline','at-li':'login','at-re':'reg','li-pl':'pw','re-pl':'pw','re-p2l':'cpw','li-btn':'loginBtn','re-btn':'regBtn',
  'sb-nav-lbl':'nav','sb-fld-lbl':'flds','t-all':'all','t-pin':'pin','t-rem':'rem','t-arc':'arc','t-del':'del','t-nf':'nf',
  'tb-ttl':null,'fm-ttl':'nf','fm-n':'fName','fm-ic':'fIco','fm-c':'fClr','fm-can':'cancel','fm-sav':'save',
  'dm-ttl':'delQ','dm-txt':'delTxt','dm-can':'cancel','dm-del':'delete',
  's-ttl':'settings','s-acc':'acc','s-em-l':'Email','s-int':'iface','s-lang-l':'lang','s-srt-l':'sort','s-vw-l':'view',
  's-data':'data','s-exp-l':'expAll','s-exp-s':'expAllS','s-exp-b':'exp','s-imp-l':'impN','s-imp-s':'impS','s-imp-b':'imp',
  's-tr-l':'clrTr','s-tr-s':'clrTrS','s-tr-b':'clr','s-lo':'logout',
  'cx-ed':'edit','cx-pin':'pinV','cx-arc':'arcV','cx-exp':'expV','cx-dup':'dup','cx-del':'delete',
  'so-upd':'sUpd','so-ttl':'sTtl','so-cre':'sCre','ss-upd':'sUpd','ss-ttl':'sTtl','ss-cre':'sCre','sv-g':'grd','sv-l':'lst',
  'esave-btn':'save','t-new-note':'createNote','ar-title':'welcome','ar-sub':'welcomeSub',
  's-scr-l':'scrSize','s-scr-s':'scrSizeS','gk-logo-text':'appName'
};
const PH = { 'si':'srch','etitle':null,'ecat':null,'tgi':null };

function applyT() {
  for(const [id,key] of Object.entries(TM)) {
    const el = document.getElementById(id);
    if(!el || !key) continue;
    el.textContent = t(key);
  }
  document.getElementById('si').placeholder = t('srch');
  document.getElementById('etitle').placeholder = t('all').includes('Note') ? 'Title...' : S.lang==='zh'?'æ ‡é¢˜...':S.lang==='es'?'TÃ­tulo...':'Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº...';
  const l = document.getElementById('ls');
  if(l) l.value = S.lang;
  // update hero wordmark lang part
  const hw = document.getElementById('hero-wm-notes');
  if(hw) hw.textContent = {ru:'Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸',en:'Notes',es:'Notas',zh:'ç¬”è®°'}[S.lang]||'Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸';
}

function aLang(lang, el) {
  S.lang = lang; localStorage.setItem('zz_lang', lang);
  document.querySelectorAll('.lang-chip').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');
  applyT();
}

function chLang(lang) {
  S.lang = lang; localStorage.setItem('zz_lang', lang); applyT();
  savePref({language:lang}); renderNotes();
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let aTab = 'li';
function sTab(tab) {
  aTab = tab;
  document.getElementById('f-li').style.display = tab==='li'?'block':'none';
  document.getElementById('f-re').style.display = tab==='re'?'block':'none';
  document.getElementById('at-li').classList.toggle('on', tab==='li');
  document.getElementById('at-re').classList.toggle('on', tab==='re');
  document.getElementById('a-err').style.display='none';
}

async function doLogin() {
  const em = document.getElementById('li-em').value.trim();
  const pw = document.getElementById('li-pw').value;
  if(!em||!pw) return;
  const btn=document.getElementById('li-btn');
  btn.innerHTML='<div class="spin"></div>';
  const d = await authApi('POST','/auth/v1/token?grant_type=password',{email:em,password:pw});
  btn.textContent = t('loginBtn');
  if(!d.access_token) { showErr(d.error_description||d.error||'Error'); return; }
  onAuth(d);
}

async function doReg() {
  const em=document.getElementById('re-em').value.trim();
  const pw=document.getElementById('re-pw').value;
  const pw2=document.getElementById('re-pw2').value;
  if(!em||!pw) return;
  if(pw!==pw2){showErr('ĞŸĞ°Ñ€Ğ¾Ğ»Ğ¸ Ğ½Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚');return;}
  const btn=document.getElementById('re-btn');
  btn.innerHTML='<div class="spin"></div>';
  const d = await authApi('POST','/auth/v1/signup',{email:em,password:pw});
  btn.textContent = t('regBtn');
  if(d.error){showErr(d.error_description||d.error);return;}
  if(d.access_token){onAuth(d);return;}
  showErr('ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ.');
}

function showErr(msg){const e=document.getElementById('a-err');e.textContent=msg;e.style.display='block';}

function onAuth(d) {
  S.tok=d.access_token; S.user=d.user;
  localStorage.setItem('zz_token',d.access_token);
  localStorage.setItem('zz_refresh',d.refresh_token||'');
  localStorage.setItem('zz_user',JSON.stringify(d.user));
  startApp();
}

async function tryAuto() {
  const tok=localStorage.getItem('zz_token');
  const usr=localStorage.getItem('zz_user');
  if(!tok||!usr) return false;
  const r = await fetch(SU+'/auth/v1/user',{headers:{'apikey':SK,'Authorization':'Bearer '+tok}});
  if(!r.ok){
    const ref=localStorage.getItem('zz_refresh');
    if(ref){const d=await authApi('POST','/auth/v1/token?grant_type=refresh_token',{refresh_token:ref});if(d.access_token){onAuth(d);return true;}}
    return false;
  }
  S.tok=tok; S.user=JSON.parse(usr); startApp(); return true;
}

function doLogout() {
  ['zz_token','zz_refresh','zz_user'].forEach(k=>localStorage.removeItem(k));
  S.user=null;S.tok=null;S.notes=[];S.folders=[];
  document.getElementById('app').style.display='none';
  document.getElementById('auth-screen').style.display='flex';
  closeSettings();
}

// â”€â”€ APP START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startApp() {
  document.getElementById('auth-screen').style.display='none';
  document.getElementById('app').style.display='flex';
  const em = S.user?.email||'';
  document.getElementById('s-em').textContent=em;
  const av=document.getElementById('gk-avatar');
  if(av)av.textContent=(em[0]||'Z').toUpperCase();
  const sz=localStorage.getItem('zz_screen')||'desktop';
  applyScreenSize(sz, false);
  await loadPrefs(); await loadFolders(); await loadNotes();
  applyT();
}

function togSidebar(){document.body.classList.toggle('sb-collapsed');}

// â”€â”€ PREFS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPrefs() {
  const {data} = await api('GET',`/rest/v1/user_preferences?user_id=eq.${S.user.id}&select=*`);
  if(Array.isArray(data)&&data.length>0){
    const p=data[0]; S.prefs=p; S.lang=p.language||S.lang;
    localStorage.setItem('zz_lang',S.lang);
    document.getElementById('ss').value=p.sort_by||'updated_at';
    document.getElementById('s-srt').value=p.sort_by||'updated_at';
    if(p.view_mode==='list'){document.getElementById('nc').classList.add('lv');document.getElementById('vb').textContent='â˜°';document.getElementById('s-vw').value='list';}
    // apply saved screen size
    const sz = localStorage.getItem('zz_screen') || 'desktop';
    applyScreenSize(sz, false);
  }
}

async function savePref(upd) {
  await api('POST','/rest/v1/user_preferences',{user_id:S.user.id,...upd,updated_at:new Date().toISOString()});
}

function chSort(v){S.prefs.sort_by=v;document.getElementById('ss').value=v;savePref({sort_by:v});renderNotes();}
function onSort(){chSort(document.getElementById('ss').value);}
function chView(v){
  S.prefs.view_mode=v;
  const c=document.getElementById('nc');
  if(v==='list'){c.classList.add('lv');document.getElementById('vb').textContent='â˜°';}
  else{c.classList.remove('lv');document.getElementById('vb').textContent='âŠ';}
  savePref({view_mode:v});
}
function togView(){const isG=!document.getElementById('nc').classList.contains('lv');chView(isG?'list':'grid');document.getElementById('s-vw').value=isG?'list':'grid';}

function applyScreenSize(size, save=true) {
  document.body.classList.remove('layout-mobile','layout-tablet','layout-desktop');
  document.body.classList.add('layout-'+size);
  // Update active button
  ['mobile','tablet','desktop'].forEach(s=>{
    document.getElementById('ssb-'+s)?.classList.toggle('active', s===size);
  });
  // Update icons: mobile=ğŸ“± tablet=â¬œ desktop=ğŸ–¥ï¸
  const icons = { mobile:'ğŸ“±', tablet:'â¬œ', desktop:'ğŸ–¥ï¸' };
  document.getElementById('ssb-mobile').textContent='ğŸ“±';
  document.getElementById('ssb-tablet').textContent='â¬œ';
  document.getElementById('ssb-desktop').textContent='ğŸ–¥ï¸';
  if(save) localStorage.setItem('zz_screen', size);
}

function chScreenSize(size) {
  applyScreenSize(size, true);
  toast(t('screenChanged', size), 'ok');
}

// â”€â”€ NOTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadNotes() {
  const {data}=await api('GET',`/rest/v1/notes?user_id=eq.${S.user.id}&select=*&order=updated_at.desc`);
  S.notes=Array.isArray(data)?data:[];
  renderNotes(); updateCnts();
}

async function saveNote() {
  const title=document.getElementById('etitle').value.trim()||'â€”';
  const content=document.getElementById('ec').innerHTML;
  const cat=document.getElementById('ecat').value.trim();
  const remV=document.getElementById('erem').value;
  const color=document.getElementById('nclr').value;
  const isPinned=document.getElementById('epin').classList.contains('on');
  const note={...(S.editing||{}),title,content,tags:S.tags,category:cat,reminder_at:remV?new Date(remV).toISOString():null,color,is_pinned:isPinned,is_archived:S.editing?.is_archived||false,is_deleted:false};
  if(note.id){
    const {id,...body}=note; body.updated_at=new Date().toISOString();
    await api('PATCH',`/rest/v1/notes?id=eq.${id}`,body);
    const i=S.notes.findIndex(n=>n.id===id);
    if(i>=0)S.notes[i]={...S.notes[i],...body,id};
  } else {
    const body={...note,user_id:S.user.id,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};
    const {data}=await api('POST','/rest/v1/notes',body);
    if(Array.isArray(data)&&data.length>0)S.notes.unshift(data[0]);
    else S.notes.unshift({...body,id:Date.now()+''});
  }
  renderNotes(); updateCnts(); closeEd(); toast(t('saved'),'ok');
}

async function delNote(id) {
  const n=S.notes.find(n=>n.id===id);
  if(!n)return;
  if(n.is_deleted){await api('DELETE',`/rest/v1/notes?id=eq.${id}`);S.notes=S.notes.filter(n=>n.id!==id);}
  else{await api('PATCH',`/rest/v1/notes?id=eq.${id}`,{is_deleted:true,updated_at:new Date().toISOString()});n.is_deleted=true;}
  renderNotes(); updateCnts(); toast(t('deleted'),'ok');
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filtNotes() {
  let ns=S.notes.filter(n=>{
    if(S.filt==='del') return n.is_deleted;
    if(n.is_deleted) return false;
    if(S.filt==='pin') return n.is_pinned;
    if(S.filt==='arc') return n.is_archived;
    if(S.filt==='rem') return !!n.reminder_at;
    return !n.is_archived;
  });
  if(S.q){const q=S.q.toLowerCase();ns=ns.filter(n=>(n.title||'').toLowerCase().includes(q)||(n.content||'').replace(/<[^>]*>/g,'').toLowerCase().includes(q)||(n.tags||[]).some(t=>t.toLowerCase().includes(q)));}
  const srt=S.prefs.sort_by||'updated_at';
  ns.sort((a,b)=>srt==='title'?(a.title||'').localeCompare(b.title||''):new Date(b[srt]||0)-new Date(a[srt]||0));
  ns.sort((a,b)=>(b.is_pinned?1:0)-(a.is_pinned?1:0));
  return ns;
}

function renderNotes() {
  const ns=filtNotes();
  document.getElementById('stats-t').textContent=t('cnt',ns.length);
  if(!ns.length){
    document.getElementById('nc').innerHTML=`<div class="empty"><svg class="empty-ic" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C7.8 12.16 7 10.63 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg><div class="empty-txt">${t('noN')}</div><div class="empty-sub">${t('noNH')}</div></div>`;
    return;
  }
  document.getElementById('nc').innerHTML=ns.map(n=>{
    const pt=(n.content||'').replace(/<[^>]*>/g,'').substring(0,200);
    const dt=fmtDate(n.updated_at);
    const tags=(n.tags||[]).slice(0,3).map(tg=>`<span class="nc-tag">${esc(tg)}</span>`).join('');
    const cb=n.color&&n.color!=='#2a2a2a'?`<div class="nc-color" style="background:${n.color}"></div>`:'';
    const rm=n.reminder_at?`<span class="nc-tag" style="color:var(--warn)">â° ${fmtDate(n.reminder_at)}</span>`:'';
    return `<div class="nc${n.is_pinned?' pinned':''}" onclick="openNote('${n.id}')" oncontextmenu="showCtx(event,'${n.id}')">
      ${cb}
      ${n.is_pinned?'<div class="nc-pin-badge">ğŸ“Œ</div>':''}
      <div class="nc-acts">
        <div class="nc-act" onclick="event.stopPropagation();qPin('${n.id}')" title="${t('pinV')}">ğŸ“Œ</div>
        <div class="nc-act d" onclick="event.stopPropagation();openDM('${n.id}')" title="${t('delete')}">ğŸ—‘</div>
      </div>
      <div class="nc-title">${esc(n.title)||'â€”'}</div>
      ${pt?`<div class="nc-preview">${esc(pt)}</div>`:''}
      <div class="nc-meta"><span class="nc-date">${dt}</span>${n.category?`<span class="nc-tag" style="background:var(--bg5)">${esc(n.category)}</span>`:''} ${tags}${rm}</div>
    </div>`;
  }).join('');
}

function updateCnts() {
  const live=S.notes.filter(n=>!n.is_deleted);
  document.getElementById('c-all').textContent=live.filter(n=>!n.is_archived).length;
  document.getElementById('c-pin').textContent=live.filter(n=>n.is_pinned).length;
  document.getElementById('c-rem').textContent=live.filter(n=>n.reminder_at).length;
  document.getElementById('c-arc').textContent=live.filter(n=>n.is_archived).length;
  document.getElementById('c-del').textContent=S.notes.filter(n=>n.is_deleted).length;
}

function fmtDate(iso) {
  if(!iso)return'';
  const d=new Date(iso),now=new Date(),diff=(now-d)/1000;
  const just={ru:'Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚Ğ¾',en:'just now',es:'ahora',zh:'åˆšåˆš'};
  if(diff<60)return just[S.lang]||'Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚Ğ¾';
  if(diff<3600){const m=Math.floor(diff/60);return S.lang==='zh'?`${m}åˆ†é’Ÿå‰`:S.lang==='es'?`hace ${m}m`:S.lang==='en'?`${m}m ago`:`${m} Ğ¼Ğ¸Ğ½`;}
  if(diff<86400){const h=Math.floor(diff/3600);return S.lang==='zh'?`${h}å°æ—¶å‰`:S.lang==='es'?`hace ${h}h`:S.lang==='en'?`${h}h ago`:`${h} Ñ‡`;}
  const loc={ru:'ru-RU',en:'en-GB',es:'es-ES',zh:'zh-CN'};
  return d.toLocaleDateString(loc[S.lang]||'ru-RU',{day:'numeric',month:'short'});
}

// â”€â”€ FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const filtTitles={all:'all',pin:'pin',rem:'rem',arc:'arc',del:'del'};
function sf(f) {
  S.filt=f; S.fFolder=null;
  document.querySelectorAll('.sb-item').forEach(e=>e.classList.remove('on'));
  document.getElementById('n-'+f)?.classList.add('on');
  document.getElementById('tb-ttl').textContent=t(filtTitles[f]||'all');
  renderNotes();
}
function onSrch(){S.q=document.getElementById('si').value;renderNotes();}

// â”€â”€ EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNew() {
  S.editing=null;S.tags=[];
  document.getElementById('etitle').value='';
  document.getElementById('ec').innerHTML='';
  document.getElementById('ecat').value='';
  document.getElementById('erem').value='';
  document.getElementById('epin').classList.remove('on');
  document.getElementById('nclr').value='#2a2a2a';
  document.getElementById('etags').innerHTML='';
  updChars();
  document.getElementById('eo').classList.add('open');
  document.getElementById('etitle').focus();
}

function openNote(id) {
  const n=S.notes.find(n=>n.id===id);
  if(!n)return;
  S.editing={...n};S.tags=[...(n.tags||[])];
  document.getElementById('etitle').value=n.title||'';
  document.getElementById('ec').innerHTML=n.content||'';
  document.getElementById('ecat').value=n.category||'';
  if(n.reminder_at){const d=new Date(n.reminder_at);document.getElementById('erem').value=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);}
  else document.getElementById('erem').value='';
  document.getElementById('epin').classList.toggle('on',!!n.is_pinned);
  document.getElementById('nclr').value=n.color||'#2a2a2a';
  rdrTags(); updChars();
  document.getElementById('eo').classList.add('open');
  document.getElementById('etitle').focus();
}

function closeEd(){document.getElementById('eo').classList.remove('open');S.editing=null;}
function togPin(){document.getElementById('epin').classList.toggle('on');}
function updChars(){const txt=document.getElementById('ec').innerText||'';document.getElementById('echars').textContent=t('chars',txt.length);}
function edKey(e){if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();saveNote();}updChars();}
function f(cmd,su=false,v=null){document.getElementById('ec').focus();document.execCommand(cmd,su,v);}
function fb(tag){document.getElementById('ec').focus();document.execCommand('formatBlock',false,tag);}
function inHR(){document.getElementById('ec').focus();document.execCommand('insertHTML',false,'<hr style="border:none;border-top:1px solid #3a3a3a;margin:12px 0">');}
function inCode(){document.getElementById('ec').focus();document.execCommand('insertHTML',false,'<code style="background:#222;padding:1px 5px;border-radius:3px;font-family:monospace;font-size:12px">code</code>');}
function inLink(){const u=prompt('URL:');if(u){document.getElementById('ec').focus();document.execCommand('createLink',false,u);}}

// â”€â”€ TAGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tagKD(e) {
  if(e.key==='Enter'||e.key===','){e.preventDefault();const v=document.getElementById('tgi').value.trim().replace(/^#/,'');if(v&&!S.tags.includes(v)){S.tags.push(v);rdrTags();}document.getElementById('tgi').value='';}
}
function rdrTags(){document.getElementById('etags').innerHTML=S.tags.map((tg,i)=>`<div class="etag">#${esc(tg)}<span class="etag-x" onclick="rmTag(${i})">âœ•</span></div>`).join('');}
function rmTag(i){S.tags.splice(i,1);rdrTags();}

// â”€â”€ FOLDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFolders() {
  const {data}=await api('GET',`/rest/v1/folders?user_id=eq.${S.user.id}&select=*&order=created_at.asc`);
  S.folders=Array.isArray(data)?data:[];
  rdrFolders();
}
function rdrFolders() {
  document.getElementById('flist').innerHTML=S.folders.map(f=>`<div class="sb-item" id="fn-${f.id}" onclick="setFF('${f.id}')" oncontextmenu="showFCtx(event,'${f.id}')"><span class="sb-item-ic">${f.icon||'ğŸ“'}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(f.name)}</span></div>`).join('');
}
function setFF(id){S.filt='folder';S.fFolder=id;document.querySelectorAll('.sb-item').forEach(e=>e.classList.remove('on'));document.getElementById('fn-'+id)?.classList.add('on');const f=S.folders.find(f=>f.id===id);document.getElementById('tb-ttl').textContent=f?.name||'';renderNotes();}
function openFolderModal(){document.getElementById('fn-i').value='';document.getElementById('fi-i').value='ğŸ“';document.getElementById('fc-i').value='#555555';document.getElementById('fm').classList.add('open');document.getElementById('fn-i').focus();}
function closeFM(){document.getElementById('fm').classList.remove('open');}
async function saveFM(){
  const n=document.getElementById('fn-i').value.trim();if(!n)return;
  const ic=document.getElementById('fi-i').value.trim()||'ğŸ“';
  const cl=document.getElementById('fc-i').value;
  const {data}=await api('POST','/rest/v1/folders',{user_id:S.user.id,name:n,icon:ic,color:cl,created_at:new Date().toISOString()});
  if(Array.isArray(data)&&data.length>0)S.folders.push(data[0]);
  rdrFolders();closeFM();
}

// â”€â”€ QUICK ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function qPin(id){const n=S.notes.find(n=>n.id===id);if(!n)return;const v=!n.is_pinned;await api('PATCH',`/rest/v1/notes?id=eq.${id}`,{is_pinned:v,updated_at:new Date().toISOString()});n.is_pinned=v;renderNotes();updateCnts();toast(v?t('pinned'):t('unpinned'));}
async function qArc(id){const n=S.notes.find(n=>n.id===id);if(!n)return;const v=!n.is_archived;await api('PATCH',`/rest/v1/notes?id=eq.${id}`,{is_archived:v,updated_at:new Date().toISOString()});n.is_archived=v;renderNotes();updateCnts();toast(v?t('arcd'):t('unarcd'));}
async function dupNote(id){const n=S.notes.find(n=>n.id===id);if(!n)return;const {id:_,created_at,updated_at,...rest}=n;rest.title=(rest.title||'')+'(2)';const {data}=await api('POST','/rest/v1/notes',{...rest,user_id:S.user.id,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(Array.isArray(data)&&data.length>0)S.notes.unshift(data[0]);renderNotes();updateCnts();toast(t('duped'));}

// â”€â”€ CTX MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showCtx(e,id){e.preventDefault();S.ctxId=id;const m=document.getElementById('ctx');m.style.display='block';m.style.left=Math.min(e.clientX,window.innerWidth-170)+'px';m.style.top=Math.min(e.clientY,window.innerHeight-200)+'px';}
function showFCtx(e,id){e.preventDefault();}
function ca(a){const id=S.ctxId;document.getElementById('ctx').style.display='none';if(!id)return;if(a==='ed')openNote(id);else if(a==='pin')qPin(id);else if(a==='arc')qArc(id);else if(a==='exp')expSingle(id);else if(a==='dup')dupNote(id);else if(a==='del')openDM(id);}
document.addEventListener('click',()=>{document.getElementById('ctx').style.display='none';});

// â”€â”€ DELETE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDM(id){S.delId=id;document.getElementById('dm').classList.add('open');}
function closeDM(){document.getElementById('dm').classList.remove('open');S.delId=null;}
async function confirmDel(){await delNote(S.delId);closeDM();}

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSettings(){document.getElementById('so').classList.add('open');}
function closeSettings(){document.getElementById('so').classList.remove('open');}

// â”€â”€ TRASH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function emptyTrash(){const tr=S.notes.filter(n=>n.is_deleted);for(const n of tr)await api('DELETE',`/rest/v1/notes?id=eq.${n.id}`);S.notes=S.notes.filter(n=>!n.is_deleted);renderNotes();updateCnts();toast(t('trEmpty'),'ok');}

// â”€â”€ ZIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exportAll(){const ns=S.notes.filter(n=>!n.is_deleted);await mkZip(ns,'zigzag-export.zip');toast(t('exported'),'ok');}
async function expSingle(id){const n=S.notes.find(n=>n.id===id);if(!n)return;const st=(n.title||'note').replace(/[^a-zA-ZĞ°-ÑĞ-Ğ¯0-9]/g,'_').substring(0,30);await mkZip([n],`zigzag-${st}.zip`);toast(t('exported'),'ok');}

async function mkZip(notes,fname){
  if(typeof JSZip==='undefined'){toast('JSZip not loaded','er');return;}
  const zip=new JSZip();const fl=zip.folder('notes');
  for(const n of notes){
    const st=(n.title||'note').replace(/[^a-zA-ZĞ°-ÑĞ-Ğ¯0-9]/g,'_').substring(0,30)+'_'+(n.id||'x').toString().slice(-5);
    const meta={id:n.id,title:n.title,content:n.content,tags:n.tags,category:n.category,color:n.color,is_pinned:n.is_pinned,is_archived:n.is_archived,reminder_at:n.reminder_at,created_at:n.created_at,updated_at:n.updated_at};
    const js=`#!/usr/bin/env node
// Zigzag Notes Export â€” ${new Date().toISOString()}
// =============================================
const note = ${JSON.stringify(meta,null,2)};

console.log('=== ' + note.title + ' ===');
console.log('Tags:', (note.tags||[]).join(', '));
console.log('Created:', note.created_at);
console.log('Updated:', note.updated_at);
console.log('---');
console.log(note.content.replace(/<[^>]*>/g,''));

module.exports = note;
`;
    fl.file(`${st}.json`,JSON.stringify(meta,null,2));
    fl.file(`${st}.js`,js);
    fl.file(`${st}.txt`,(n.title||'')+'\n'+'='.repeat(40)+'\n'+(n.content||'').replace(/<[^>]*>/g,''));
  }
  zip.file('manifest.json',JSON.stringify({app:'Zigzag Notes',version:'1.0',exported_at:new Date().toISOString(),notes_count:notes.length,notes:notes.map(n=>({id:n.id,title:n.title,updated_at:n.updated_at}))},null,2));
  zip.file('README.md',`# Zigzag Notes Export\n\nExported: ${new Date().toLocaleString()}\nNotes: ${notes.length}\n\n## Import\nOpen Zigzag Notes â†’ ğŸ“¥ â†’ select this file.\n\n## Files\n- \`notes/*.json\` â€” metadata\n- \`notes/*.js\` â€” importable script\n- \`notes/*.txt\` â€” plain text\n`);
  const blob=await zip.generateAsync({type:'blob'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=fname;a.click();URL.revokeObjectURL(url);
}

function doImport(){document.getElementById('zip-fi').click();}
async function handleZip(e){
  const file=e.target.files[0];if(!file)return;
  if(typeof JSZip==='undefined'){toast('JSZip not loaded','er');return;}
  try{
    const zip=await JSZip.loadAsync(file);
    const mf=zip.file('manifest.json');let cnt=0;
    if(mf){
      const m=JSON.parse(await mf.async('text'));
      for(const ni of(m.notes||[])){
        const st=(ni.title||'note').replace(/[^a-zA-ZĞ°-ÑĞ-Ğ¯0-9]/g,'_').substring(0,30)+'_'+(ni.id||'').toString().slice(-5);
        const jf=zip.file(`notes/${st}.json`);
        if(jf){try{const txt=await jf.async('text');const nd=JSON.parse(txt);const {id:_,...rest}=nd;const {data}=await api('POST','/rest/v1/notes',{...rest,user_id:S.user.id,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(Array.isArray(data)&&data.length>0)S.notes.unshift(data[0]);cnt++;}catch(err){}}
      }
    }else{
      const jf=Object.keys(zip.files).filter(f=>f.endsWith('.json'));
      for(const fn of jf){try{const txt=await zip.file(fn).async('text');const nd=JSON.parse(txt);if(nd.title!==undefined){const {id:_,...rest}=nd;const {data}=await api('POST','/rest/v1/notes',{...rest,user_id:S.user.id,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(Array.isArray(data)&&data.length>0)S.notes.unshift(data[0]);cnt++;}}catch(er){}}
    }
    renderNotes();updateCnts();toast(t('imported',cnt),'ok');
  }catch(er){toast('Import error: '+er.message,'er');}
  e.target.value='';
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg,type=''){const el=document.createElement('div');el.className='toast'+(type?' '+type:'');const ic=type==='ok'?'âœ…':type==='er'?'âŒ':'â„¹ï¸';el.innerHTML=`<span>${ic}</span> ${esc(msg)}`;document.getElementById('toast-c').appendChild(el);setTimeout(()=>el.remove(),3000);}

// â”€â”€ CLOSE OVERLAYS ON BG CLICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('eo').addEventListener('click',function(e){if(e.target===this)closeEd();});
['fm','dm','so'].forEach(id=>{document.getElementById(id)?.addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
applyT();
tryAuto().then(ok=>{if(!ok)document.getElementById('auth-screen').style.display='flex';});
</script>
</body>
</html>

</body>
</html>
